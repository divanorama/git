#!/bin/bash
set -o pipefail
set -e

die () {
	printf >&2 'fatal: %s\n' "$*"
	exit 128
}

usage () {
	printf >&2 'usage: %s\n' "$*"
	exit 129
}

try_svnrdump () {
	command -v svnrdump >/dev/null &&
	echo "svnrdump dump --non-interactive --username=Guest --password= \
		--quiet --incremental" ||
	true
}

svnadmin_wrap () {
	path=${1##file://} &&
	test "z$path" != "z$1" &&
	svnadmin dump --incremental --deltas --quiet "$path" "$2"
}

try_svnadmin () {
	command -v svnadmin >/dev/null &&
	echo svnadmin_wrap ||
	true
}

SVNDUMP=""
SVNDUMP=${SVNDUMP:-`try_svnrdump`}
SVNDUMP=${SVNDUMP:-`try_svnadmin`}

do_import () {
	revs=$1 url=$2 dst=$3
	(eval "$SVNDUMP \"$url\" -r\"$revs\"" |	svn-fe --ref="$dst" --no-progress) 3<&0 || die "FAILURE"
	exec 1>&-
}

test "${2+set}" ||
usage 'git remote-svn-alpha <repository> <URL> < commandlist'
repo=$1
url=$2
need_import=""
remote_ref="refs/heads/master"
private_ref="refs/svn-alpha/$repo/SVNHEAD"

while read -r cmd args
do
	case $cmd in
	capabilities)
		echo import
		echo "refspec HEAD:$private_ref"
		echo "refspec $remote_ref:$private_ref"
		echo
		;;
	list)
		echo "? HEAD"
		echo "? $remote_ref"
		echo
		;;
	import)
		test "$args" = "HEAD" || test "$args" = "$remote_ref" ||
		die "remote-svn-alpha: unsupported import ref argument: $args"
		need_import="yes"
		;;
	'')
		test "$need_import" = "yes" || exit 0
		do_import 0:HEAD "$url" "$private_ref"
		need_import=""
		;;
	*)
		die "remote-svn-alpha: unsupported command: $cmd $args"
	esac
done
